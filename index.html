<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPhone/iPad Data Mapper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=SÃ¶hne+Mono,monospace&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --white: #ffffff;
            --black: #000000;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-400: #a3a3a3;
            --gray-600: #525252;
            --border-width: 1.5px;
        }

        body {
            font-family: 'Instrument Sans', -apple-system, sans-serif;
            background: var(--white);
            color: var(--black);
            min-height: 100vh;
            padding: 40px 24px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 1100px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        header {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: var(--border-width) solid var(--black);
        }

        .header-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1.1;
        }

        .version-tag {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 500;
            padding: 4px 8px;
            border: var(--border-width) solid var(--black);
            background: var(--white);
            letter-spacing: 0.5px;
        }

        .subtitle {
            font-size: 14px;
            color: var(--gray-600);
            margin-top: 8px;
        }

        .card {
            background: var(--white);
            border: var(--border-width) solid var(--black);
        }

        .upload-section {
            padding: 24px;
            border-bottom: var(--border-width) solid var(--black);
        }

        .section-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .section-label svg {
            width: 14px;
            height: 14px;
        }

        .drop-zone {
            padding: 36px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            border: var(--border-width) dashed var(--black);
            background: var(--white);
        }

        .drop-zone:hover,
        .drop-zone.dragover {
            background: var(--gray-100);
        }

        .drop-zone-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            border: var(--border-width) solid var(--black);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drop-zone-icon svg {
            width: 22px;
            height: 22px;
        }

        .drop-zone p {
            font-size: 14px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 4px;
        }

        .drop-zone .hint {
            font-size: 12px;
            color: var(--gray-600);
        }

        #fileInput {
            display: none;
        }

        .file-loaded {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--white);
            border: var(--border-width) solid var(--black);
        }

        .file-icon {
            width: 44px;
            height: 44px;
            background: var(--black);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 2px;
        }

        .file-meta {
            font-size: 11px;
            color: var(--gray-600);
            font-family: 'JetBrains Mono', monospace;
        }

        .btn-clear {
            background: var(--white);
            border: var(--border-width) solid var(--black);
            color: var(--black);
            padding: 8px 16px;
            font-family: 'Instrument Sans', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-clear:hover {
            background: var(--black);
            color: var(--white);
        }

        .status-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            font-size: 13px;
            margin: 20px 24px 0;
            border: var(--border-width) solid var(--black);
        }

        .status-message.success {
            background: var(--white);
        }

        .status-message.error {
            background: var(--gray-100);
        }

        .status-message svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .preview-section {
            padding: 24px;
        }

        .preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .preview-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .preview-count {
            font-size: 11px;
            color: var(--black);
            font-family: 'JetBrains Mono', monospace;
            background: var(--white);
            padding: 4px 10px;
            border: var(--border-width) solid var(--black);
        }

        .preview-table-container {
            border: var(--border-width) solid var(--black);
            overflow: hidden;
            position: relative;
            max-width: 100%;
            contain: inline-size;
        }

        .preview-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .preview-table.expanded {
            table-layout: auto;
            width: max-content;
            min-width: 100%;
        }

        .preview-table.expanded th {
            white-space: nowrap;
        }

        .preview-table th {
            text-align: left;
            padding: 12px 14px;
            background: var(--black);
            color: var(--white);
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .preview-table td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--gray-200);
            color: var(--black);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .preview-table.expanded td {
            max-width: none;
            white-space: nowrap;
        }

        .preview-table tbody tr:hover {
            background: var(--gray-100);
        }

        .preview-table tr:last-child td {
            border-bottom: none;
        }

        .preview-scroll {
            max-height: 280px;
            overflow-y: auto;
            overflow-x: auto;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .preview-scroll.expanded {
            max-height: 60vh;
            overflow: auto;
        }

        .preview-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .preview-scroll::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .preview-scroll::-webkit-scrollbar-thumb {
            background: var(--black);
            border-radius: 0;
        }

        .preview-scroll::-webkit-scrollbar-corner {
            background: var(--gray-100);
        }

        .actions {
            display: flex;
            gap: 0;
            border-top: var(--border-width) solid var(--black);
        }

        .btn-primary {
            flex: 1;
            background: var(--black);
            color: var(--white);
            border: none;
            padding: 18px 24px;
            font-family: 'Instrument Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--gray-600);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--white);
            color: var(--black);
            border: none;
            border-right: var(--border-width) solid var(--black);
            padding: 18px 28px;
            font-family: 'Instrument Sans', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-secondary:hover {
            background: var(--gray-100);
        }

        .empty-state {
            padding: 56px 24px;
            text-align: center;
        }

        .empty-state-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 20px;
            border: var(--border-width) solid var(--black);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state-icon svg {
            width: 24px;
            height: 24px;
            color: var(--gray-400);
        }

        .empty-state p {
            font-size: 13px;
            color: var(--gray-600);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'JetBrains Mono', monospace;
            border: var(--border-width) solid var(--black);
        }

        .badge-new {
            background: var(--black);
            color: var(--white);
        }

        .badge-replacement {
            background: var(--white);
            color: var(--black);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-in {
            animation: fadeIn 0.25s ease forwards;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--black);
            color: var(--white);
            padding: 16px 24px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-icon {
            color: var(--white);
        }

        .more-records {
            font-size: 11px;
            color: var(--gray-600);
            text-align: center;
            padding: 12px;
            border-top: 1px solid var(--gray-200);
            font-family: 'JetBrains Mono', monospace;
        }

        .expand-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px;
            background: var(--gray-100);
            border: none;
            border-top: var(--border-width) solid var(--black);
            width: 100%;
            cursor: pointer;
            font-family: 'Instrument Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--black);
            transition: background 0.15s ease;
        }

        .expand-toggle:hover {
            background: var(--gray-200);
        }

        .expand-toggle svg {
            width: 14px;
            height: 14px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .expand-toggle.expanded svg {
            transform: rotate(180deg);
        }

        .expand-toggle.expanded {
            background: var(--black);
            color: var(--white);
        }

        .expand-toggle.expanded:hover {
            background: var(--gray-600);
        }

        /* Fade gradient overlay when collapsed */
        .preview-fade {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(to bottom, transparent, var(--white));
            pointer-events: none;
            opacity: 1;
            transition: opacity 0.3s ease;
            z-index: 5;
        }

        .preview-fade.hidden {
            opacity: 0;
        }

        /* Column count indicator */
        .column-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: var(--gray-600);
            font-family: 'JetBrains Mono', monospace;
            margin-left: 12px;
            padding: 3px 8px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
        }

        .column-indicator svg {
            width: 12px;
            height: 12px;
        }

        /* Smooth row reveal animation */
        @keyframes rowReveal {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-table tbody tr.revealing {
            animation: rowReveal 0.25s ease forwards;
        }

        /* Consumables Section */
        .consumables-card {
            background: var(--white);
            border: var(--border-width) solid var(--black);
            position: sticky;
            top: 24px;
        }

        .consumables-header {
            padding: 20px 24px;
            border-bottom: var(--border-width) solid var(--black);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .consumables-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .consumables-title svg {
            width: 16px;
            height: 16px;
        }

        .consumables-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            font-weight: 500;
            padding: 4px 10px;
            border: var(--border-width) solid var(--black);
            background: var(--black);
            color: var(--white);
            letter-spacing: 0.5px;
        }

        .consumables-body {
            padding: 0;
        }

        .consumables-empty {
            padding: 48px 24px;
            text-align: center;
        }

        .consumables-empty-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            border: var(--border-width) solid var(--black);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .consumables-empty-icon svg {
            width: 20px;
            height: 20px;
            color: var(--gray-400);
        }

        .consumables-empty p {
            font-size: 12px;
            color: var(--gray-600);
        }

        .consumables-table {
            width: 100%;
            border-collapse: collapse;
        }

        .consumables-table th {
            text-align: left;
            padding: 12px 16px;
            background: var(--black);
            color: var(--white);
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .consumables-table th:last-child {
            text-align: right;
            width: 80px;
        }

        .consumables-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--gray-200);
            font-size: 12px;
        }

        .consumables-table td:last-child {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 13px;
        }

        .consumables-table tbody tr:last-child td {
            border-bottom: none;
        }

        .consumables-table tbody tr:hover {
            background: var(--gray-100);
        }

        .consumable-category {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-600);
            padding: 10px 16px 6px;
            background: var(--gray-100);
            border-bottom: 1px solid var(--gray-200);
        }

        .consumable-item-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .consumable-dot {
            width: 6px;
            height: 6px;
            background: var(--black);
            flex-shrink: 0;
        }

        .consumable-dot.laptop {
            background: var(--black);
        }

        .consumable-dot.mobile {
            background: var(--gray-600);
        }

        .consumable-dot.tablet {
            background: var(--gray-400);
        }

        .consumables-footer {
            padding: 14px 16px;
            border-top: var(--border-width) solid var(--black);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--gray-100);
        }

        .consumables-total-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .consumables-total-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            font-weight: 700;
        }

        .consumables-scroll {
            max-height: 500px;
            overflow-y: auto;
        }

        .consumables-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .consumables-scroll::-webkit-scrollbar-track {
            background: var(--white);
        }

        .consumables-scroll::-webkit-scrollbar-thumb {
            background: var(--black);
        }

        .zero-count {
            color: var(--gray-400);
        }

        .has-count {
            color: var(--black);
        }

        /* ===== NEW FEATURE STYLES ===== */

        /* Search Box */
        .search-container {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 10px 14px;
            border: var(--border-width) solid var(--black);
            font-family: 'Instrument Sans', sans-serif;
            font-size: 13px;
            background: var(--white);
            outline: none;
            transition: background 0.15s ease;
        }

        .search-input:focus {
            background: var(--gray-100);
        }

        .search-input::placeholder {
            color: var(--gray-400);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border: var(--border-width) solid var(--black);
            background: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .btn-icon:hover {
            background: var(--gray-100);
        }

        .btn-icon.active {
            background: var(--black);
            color: var(--white);
        }

        .btn-icon svg {
            width: 16px;
            height: 16px;
        }

        /* Duplicate/Filter Warning Panel */
        .warning-panel {
            margin: 16px 24px 0;
            padding: 14px 18px;
            border: var(--border-width) solid var(--black);
            background: #fffbeb;
        }

        .warning-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .warning-header svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .warning-toggle {
            margin-left: auto;
            transition: transform 0.2s ease;
        }

        .warning-toggle.expanded {
            transform: rotate(180deg);
        }

        .warning-details {
            display: none;
            font-size: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--gray-200);
        }

        .warning-details.show {
            display: block;
        }

        .warning-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        .warning-item-dot {
            width: 6px;
            height: 6px;
            background: var(--black);
            flex-shrink: 0;
        }

        /* Filter Breakdown */
        .filter-breakdown {
            margin-top: 8px;
            padding: 10px 14px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }

        .filter-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }

        .filter-item-label {
            color: var(--gray-600);
        }

        .filter-item-count {
            font-weight: 600;
        }

        /* Editable Cells */
        .preview-table td[contenteditable="true"] {
            cursor: text;
            position: relative;
        }

        .preview-table td[contenteditable="true"]:focus {
            outline: 2px solid var(--black);
            outline-offset: -2px;
            background: #fffef0;
        }

        .preview-table td.edited {
            background: #f0fdf4;
        }

        .preview-table td.edited::after {
            content: '';
            position: absolute;
            top: 4px;
            right: 4px;
            width: 6px;
            height: 6px;
            background: #22c55e;
            border-radius: 50%;
        }

        /* Source Preview Toggle */
        .source-preview-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--gray-200);
        }

        .source-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--white);
            border: var(--border-width) solid var(--black);
            font-family: 'Instrument Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .source-toggle-btn:hover {
            background: var(--gray-100);
        }

        .source-toggle-btn.active {
            background: var(--black);
            color: var(--white);
        }

        .source-toggle-btn svg {
            width: 14px;
            height: 14px;
        }

        .source-data-container {
            display: none;
            margin-top: 12px;
        }

        .source-data-container.show {
            display: block;
        }

        .source-preview-section {
            max-width: 100%;
            overflow: hidden;
            contain: inline-size;
        }

        .source-table {
            width: max-content;
            min-width: 100%;
            font-size: 11px;
            border-collapse: collapse;
            table-layout: auto;
        }

        .source-table th {
            text-align: left;
            padding: 10px 12px;
            background: var(--gray-600);
            color: var(--white);
            font-weight: 600;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .source-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--gray-200);
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            white-space: nowrap;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .source-scroll {
            max-height: 280px;
            overflow: auto;
            border: var(--border-width) solid var(--gray-400);
            max-width: 100%;
        }

        .source-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .source-scroll::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .source-scroll::-webkit-scrollbar-thumb {
            background: var(--gray-600);
            border-radius: 0;
        }

        .source-scroll::-webkit-scrollbar-corner {
            background: var(--gray-100);
        }

        /* Consumables Download Button */
        .consumables-actions {
            display: flex;
            gap: 0;
            border-top: var(--border-width) solid var(--black);
        }

        .btn-consumables-download {
            flex: 1;
            background: var(--white);
            color: var(--black);
            border: none;
            padding: 14px 16px;
            font-family: 'Instrument Sans', sans-serif;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-consumables-download:hover {
            background: var(--black);
            color: var(--white);
        }

        .btn-consumables-download svg {
            width: 14px;
            height: 14px;
        }

        /* Reset Edits Button */
        .reset-edits-btn {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            margin-left: 8px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            font-family: 'Instrument Sans', sans-serif;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .reset-edits-btn:hover {
            background: var(--gray-200);
        }

        .reset-edits-btn.show {
            display: inline-flex;
        }

        .reset-edits-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Edit mode indicator */
        .edit-mode-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            font-size: 10px;
            font-weight: 500;
            color: #166534;
            margin-left: 12px;
        }

        .edit-mode-indicator.show {
            display: inline-flex;
        }

        .edit-mode-indicator svg {
            width: 12px;
            height: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-top">
                <h1>iPhone/iPad<br>Data Mapper</h1>
                <span class="version-tag">V2.1</span>
            </div>
            <p class="subtitle">Upload source file to map device data and calculate consumables</p>
        </header>

        <div class="main-grid">
            <div class="card">
                <div class="upload-section">
                    <div class="section-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                        Upload Source File
                    </div>
                    <div id="sourceContent">
                        <div class="drop-zone" id="dropZone">
                            <div class="drop-zone-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                    <polyline points="14 2 14 8 20 8" />
                                    <line x1="16" y1="13" x2="8" y2="13" />
                                    <line x1="16" y1="17" x2="8" y2="17" />
                                    <polyline points="10 9 9 9 8 9" />
                                </svg>
                            </div>
                            <p>Drop your CSV or Excel file here</p>
                            <span class="hint">Supports .csv, .xlsx, .xls</span>
                        </div>
                    </div>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
                </div>

                <div id="statusArea"></div>

                <div id="previewSection" style="display: none;">
                    <div class="preview-section">
                        <div class="preview-header">
                            <div style="display: flex; align-items: center; flex-wrap: wrap;">
                                <span class="preview-title">Mapped Output</span>
                                <span class="preview-count" id="outputCount">0 records</span>
                                <span class="column-indicator" id="columnIndicator" style="display: none;">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="7" height="7" />
                                        <rect x="14" y="3" width="7" height="7" />
                                        <rect x="14" y="14" width="7" height="7" />
                                        <rect x="3" y="14" width="7" height="7" />
                                    </svg>
                                    <span id="columnCount">6 cols</span>
                                </span>
                                <span class="edit-mode-indicator" id="editModeIndicator">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                                    </svg>
                                    Edit Mode
                                </span>
                                <button class="reset-edits-btn" id="resetEditsBtn">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="1 4 1 10 7 10" />
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" />
                                    </svg>
                                    Reset Edits
                                </button>
                            </div>
                        </div>
                        <!-- Search Box -->
                        <div class="search-container">
                            <input type="text" class="search-input" id="searchInput"
                                placeholder="Search by name, IMEI, task number, asset tag...">
                            <button class="btn-icon" id="clearSearchBtn" title="Clear search">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18" />
                                    <line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                            </button>
                            <button class="btn-icon" id="sourceToggleBtn" title="Toggle source columns">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                    <line x1="12" y1="3" x2="12" y2="21" />
                                </svg>
                            </button>
                        </div>
                        <div class="preview-table-container">
                            <div class="preview-scroll" id="previewScroll">
                                <table class="preview-table" id="previewTable">
                                    <thead id="previewHead">
                                        <tr>
                                            <th>Status</th>
                                            <th>Task Number</th>
                                            <th>Full Name</th>
                                            <th>Device</th>
                                            <th>Bundle</th>
                                            <th>Asset Tag</th>
                                        </tr>
                                    </thead>
                                    <tbody id="previewBody"></tbody>
                                </table>
                            </div>
                            <div class="preview-fade" id="previewFade"></div>
                        </div>
                        <button class="expand-toggle" id="expandBtn" style="display: none;">
                            <span id="expandBtnText">Expand All Rows &amp; Columns</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9" />
                            </svg>
                        </button>
                        <!-- Source Preview Section -->
                        <div class="source-preview-section" id="sourcePreviewSection" style="display: none;">
                            <div class="source-scroll" id="sourceScroll">
                                <table class="source-table" id="sourceTable">
                                    <thead id="sourceHead"></thead>
                                    <tbody id="sourceBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-secondary" id="resetBtn">Reset</button>
                        <button class="btn-primary" id="downloadBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg>
                            Download Mapped CSV
                        </button>
                    </div>
                </div>

                <div id="emptyPreview">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <line x1="3" y1="9" x2="21" y2="9" />
                                <line x1="9" y1="21" x2="9" y2="9" />
                            </svg>
                        </div>
                        <p>Upload a source file to generate mapped output</p>
                    </div>
                </div>
            </div>

            <!-- Consumables Card -->
            <div class="consumables-card">
                <div class="consumables-header">
                    <div class="consumables-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 7h-9" />
                            <path d="M14 17H5" />
                            <circle cx="17" cy="17" r="3" />
                            <circle cx="7" cy="7" r="3" />
                        </svg>
                        Consumable Count
                    </div>
                    <span class="consumables-badge" id="consumablesBadge">0 ITEMS</span>
                </div>
                <div class="consumables-body">
                    <div id="consumablesEmpty" class="consumables-empty">
                        <div class="consumables-empty-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path
                                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                                <line x1="12" y1="22.08" x2="12" y2="12" />
                            </svg>
                        </div>
                        <p>Upload a source file to calculate consumables</p>
                    </div>
                    <div id="consumablesContent" style="display: none;">
                        <div class="consumables-scroll">
                            <table class="consumables-table">
                                <thead>
                                    <tr>
                                        <th>Consumable Item</th>
                                        <th>Count</th>
                                    </tr>
                                </thead>
                                <tbody id="consumablesBody"></tbody>
                            </table>
                        </div>
                        <div class="consumables-footer">
                            <span class="consumables-total-label">Total Items</span>
                            <span class="consumables-total-count" id="consumablesTotalCount">0</span>
                        </div>
                        <div class="consumables-actions">
                            <button class="btn-consumables-download" id="downloadConsumablesBtn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="7 10 12 15 17 10" />
                                    <line x1="12" y1="15" x2="12" y2="3" />
                                </svg>
                                Download Consumables CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- end main-grid -->
    </div>

    <div class="toast" id="toast">
        <span class="toast-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
        </span>
        <span id="toastMessage">File downloaded successfully</span>
    </div>

    <script>
        let sourceData = [];
        let mappedData = [];
        let originalMappedData = []; // For reset edits functionality
        let consumableCounts = {};
        let filterStats = { total: 0, iPhones: 0, iPads: 0, laptops: 0, desktops: 0, unknown: 0 };
        let duplicateWarnings = { imei: [], serial: [], asset: [] };
        let searchTerm = '';
        let hasEdits = false;
        let sourceRowMapping = []; // Maps output rows to source row indices

        /*
         * Expected Source File Column Structure:
         * Column A: [varies]
         * Column B: [varies]
         * Column C: Month
         * Column D: Stock Movement Date (ignored in output - present in source but not mapped)
         * 
         * Key columns used for mapping (accessed by name, not position):
         * - TASK REF / INC REF: Used for Tialis TASK NUMBER and determining STATUS
         * - USER'S NAME: Maps to Full Name
         * - MODEL REQUIRED: Used to determine device type, bundle status, and phone/iPad model
         * - DEVICE TYPE: Fallback for device type determination
         * - DATE TO BE SHIPPED: Maps to PO (Order date) and Date Shipped
         * - EID NUMBER: Maps to EID Number
         * - SERIAL NUMBER: Maps to Serial Number
         * - IMEI NUMBER: Maps to IMEI Number (with prefix stripping)
         * - ASSET TAG: Maps to ASSET Tag
         * - NS/REP: Used for consumables calculation
         * - SHIPPING MODEL / SHIPPED MODEL: Used for determining phone/iPad model
         */

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const sourceContent = document.getElementById('sourceContent');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const outputCount = document.getElementById('outputCount');
        const previewBody = document.getElementById('previewBody');
        const previewHead = document.getElementById('previewHead');
        const previewTable = document.getElementById('previewTable');
        const previewScroll = document.getElementById('previewScroll');
        const previewFade = document.getElementById('previewFade');
        const previewSection = document.getElementById('previewSection');
        const emptyPreview = document.getElementById('emptyPreview');
        const statusArea = document.getElementById('statusArea');
        const expandBtn = document.getElementById('expandBtn');
        const expandBtnText = document.getElementById('expandBtnText');
        const columnIndicator = document.getElementById('columnIndicator');
        const columnCount = document.getElementById('columnCount');

        // Consumables DOM elements
        const consumablesBody = document.getElementById('consumablesBody');
        const consumablesEmpty = document.getElementById('consumablesEmpty');
        const consumablesContent = document.getElementById('consumablesContent');
        const consumablesBadge = document.getElementById('consumablesBadge');
        const consumablesTotalCount = document.getElementById('consumablesTotalCount');
        const downloadConsumablesBtn = document.getElementById('downloadConsumablesBtn');

        // New feature DOM elements
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const sourceToggleBtn = document.getElementById('sourceToggleBtn');
        const sourcePreviewSection = document.getElementById('sourcePreviewSection');
        const sourceHead = document.getElementById('sourceHead');
        const sourceBody = document.getElementById('sourceBody');
        const editModeIndicator = document.getElementById('editModeIndicator');
        const resetEditsBtn = document.getElementById('resetEditsBtn');

        let isExpanded = false;
        let isSourceVisible = false;

        // Destination headers
        const destHeaders = [
            'STATUS', 'Tialis TASK NUMBER', 'PO (Order date)', 'COST CENTRE', 'Full Name',
            'Employee ID', 'Employee Email', 'Agency', 'Equipment Account', 'Airtime Account',
            'Device Type', 'Product code', 'Quantity', 'Device Operating System', 'Device Make',
            'EID Number', 'Serial Number', 'IMEI Number', 'Organisational Group', 'Talk plan & Bundle',
            'Data cap', 'Physical SIM Card Required', 'Physical SIM Card Number', 'Date Shipped',
            'ASSET Tag', 'Device Bundle / Device Type', 'iPhone number (to be added by EE)'
        ];

        // Initialize event listeners
        function initDropZone(zone) {
            zone.addEventListener('click', () => fileInput.click());
            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && isValidFileType(file.name)) {
                    processFile(file);
                }
            });
        }

        initDropZone(dropZone);

        function isValidFileType(filename) {
            const ext = filename.toLowerCase();
            return ext.endsWith('.csv') || ext.endsWith('.xlsx') || ext.endsWith('.xls');
        }

        function getFileExtension(filename) {
            return filename.toLowerCase().split('.').pop();
        }

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                processFile(e.target.files[0]);
            }
        });

        downloadBtn.addEventListener('click', downloadCSV);
        resetBtn.addEventListener('click', clearFile);
        expandBtn.addEventListener('click', toggleExpand);

        // New feature event listeners
        searchInput.addEventListener('input', handleSearch);
        clearSearchBtn.addEventListener('click', clearSearch);
        sourceToggleBtn.addEventListener('click', toggleSourcePreview);
        resetEditsBtn.addEventListener('click', resetEdits);
        downloadConsumablesBtn.addEventListener('click', downloadConsumablesCSV);

        // ===== EXCEL DATE PARSING =====
        function parseExcelDate(value) {
            // Check if value is a number (Excel serial date)
            const num = Number(value);
            if (!isNaN(num) && num > 30000 && num < 60000) {
                // Excel serial date: days since 1900-01-01 (with Excel bug for 1900 leap year)
                const date = new Date((num - 25569) * 86400 * 1000);
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            return value;
        }

        // ===== USB-C DEVICE DETECTION =====
        function isUSBCDevice(modelRequired, shippingModel) {
            const model = (modelRequired || '').toLowerCase();
            const shipped = (shippingModel || '').toLowerCase();
            const combined = model + ' ' + shipped;

            // iPhone 15/16 series use USB-C
            if (combined.includes('iphone 15') || combined.includes('iphone 16')) {
                return true;
            }

            // iPad 10th Gen and later use USB-C
            if (combined.includes('ipad')) {
                if (combined.includes('10th') || combined.includes('10 gen') ||
                    combined.includes('11th') || combined.includes('11 gen') ||
                    combined.includes('pro') || combined.includes('air')) {
                    return true;
                }
            }

            return false;
        }

        // ===== SEARCH FUNCTIONALITY =====
        function handleSearch() {
            searchTerm = searchInput.value.toLowerCase().trim();
            renderPreviewTable();
        }

        function clearSearch() {
            searchInput.value = '';
            searchTerm = '';
            renderPreviewTable();
        }

        function filterBySearch(data) {
            if (!searchTerm) return data;
            return data.filter(row => {
                return Object.values(row).some(val =>
                    String(val).toLowerCase().includes(searchTerm)
                );
            });
        }

        // ===== SOURCE PREVIEW TOGGLE =====
        function toggleSourcePreview() {
            isSourceVisible = !isSourceVisible;
            sourceToggleBtn.classList.toggle('active', isSourceVisible);
            sourcePreviewSection.style.display = isSourceVisible ? 'block' : 'none';

            if (isSourceVisible) {
                renderSourcePreview();
            }
        }

        function renderSourcePreview() {
            if (!sourceData.length) return;

            // Get source headers (keys from first row)
            const headers = Object.keys(sourceData[0]);

            // Render header
            sourceHead.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            // Get filtered data matching current view
            const filteredMapped = filterBySearch(mappedData);
            const indicesToShow = filteredMapped.map(row => {
                const idx = originalMappedData.findIndex(orig =>
                    orig['IMEI Number'] === row['IMEI Number'] &&
                    orig['Serial Number'] === row['Serial Number']
                );
                return sourceRowMapping[idx];
            }).filter(idx => idx !== undefined);

            // Show source rows that correspond to mapped output
            const rowsToShow = indicesToShow.length > 0 ?
                indicesToShow.map(idx => sourceData[idx]) :
                sourceData.slice(0, mappedData.length);

            sourceBody.innerHTML = rowsToShow.map(row => {
                return `<tr>${headers.map(h => `<td>${row[h] || '-'}</td>`).join('')}</tr>`;
            }).join('');
        }

        // ===== DUPLICATE DETECTION =====
        function detectDuplicates() {
            duplicateWarnings = { imei: [], serial: [], asset: [] };

            const imeiMap = {};
            const serialMap = {};
            const assetMap = {};

            mappedData.forEach((row, idx) => {
                const imei = row['IMEI Number'];
                const serial = row['Serial Number'];
                const asset = row['ASSET Tag'];

                if (imei && imei !== '-') {
                    if (imeiMap[imei] !== undefined) {
                        if (!duplicateWarnings.imei.find(d => d.value === imei)) {
                            duplicateWarnings.imei.push({ value: imei, rows: [imeiMap[imei] + 1, idx + 1] });
                        } else {
                            duplicateWarnings.imei.find(d => d.value === imei).rows.push(idx + 1);
                        }
                    } else {
                        imeiMap[imei] = idx;
                    }
                }

                if (serial && serial !== '-') {
                    if (serialMap[serial] !== undefined) {
                        if (!duplicateWarnings.serial.find(d => d.value === serial)) {
                            duplicateWarnings.serial.push({ value: serial, rows: [serialMap[serial] + 1, idx + 1] });
                        } else {
                            duplicateWarnings.serial.find(d => d.value === serial).rows.push(idx + 1);
                        }
                    } else {
                        serialMap[serial] = idx;
                    }
                }

                if (asset && asset !== '-') {
                    if (assetMap[asset] !== undefined) {
                        if (!duplicateWarnings.asset.find(d => d.value === asset)) {
                            duplicateWarnings.asset.push({ value: asset, rows: [assetMap[asset] + 1, idx + 1] });
                        } else {
                            duplicateWarnings.asset.find(d => d.value === asset).rows.push(idx + 1);
                        }
                    } else {
                        assetMap[asset] = idx;
                    }
                }
            });
        }

        function renderDuplicateWarnings() {
            const totalDupes = duplicateWarnings.imei.length + duplicateWarnings.serial.length + duplicateWarnings.asset.length;
            if (totalDupes === 0) return '';

            let detailsHtml = '';
            if (duplicateWarnings.imei.length) {
                detailsHtml += duplicateWarnings.imei.map(d =>
                    `<div class="warning-item"><div class="warning-item-dot"></div>IMEI: ${d.value} (rows ${d.rows.join(', ')})</div>`
                ).join('');
            }
            if (duplicateWarnings.serial.length) {
                detailsHtml += duplicateWarnings.serial.map(d =>
                    `<div class="warning-item"><div class="warning-item-dot"></div>Serial: ${d.value} (rows ${d.rows.join(', ')})</div>`
                ).join('');
            }
            if (duplicateWarnings.asset.length) {
                detailsHtml += duplicateWarnings.asset.map(d =>
                    `<div class="warning-item"><div class="warning-item-dot"></div>Asset Tag: ${d.value} (rows ${d.rows.join(', ')})</div>`
                ).join('');
            }

            return `
                <div class="warning-panel animate-in">
                    <div class="warning-header" onclick="toggleWarningDetails(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span>${totalDupes} Duplicate${totalDupes > 1 ? 's' : ''} Detected</span>
                        <svg class="warning-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div class="warning-details">${detailsHtml}</div>
                </div>
            `;
        }

        function toggleWarningDetails(header) {
            const details = header.nextElementSibling;
            const toggle = header.querySelector('.warning-toggle');
            details.classList.toggle('show');
            toggle.classList.toggle('expanded');
        }

        // ===== FILTERING EXPLANATION =====
        function renderFilterBreakdown() {
            const filtered = filterStats.total - filterStats.iPhones - filterStats.iPads;
            if (filtered === 0) return '';

            return `
                <div class="filter-breakdown">
                    <div class="filter-item">
                        <span class="filter-item-label">Total rows in file:</span>
                        <span class="filter-item-count">${filterStats.total}</span>
                    </div>
                    <div class="filter-item">
                        <span class="filter-item-label">iPhones processed:</span>
                        <span class="filter-item-count">${filterStats.iPhones}</span>
                    </div>
                    <div class="filter-item">
                        <span class="filter-item-label">iPads processed:</span>
                        <span class="filter-item-count">${filterStats.iPads}</span>
                    </div>
                    <div class="filter-item">
                        <span class="filter-item-label">Laptops filtered:</span>
                        <span class="filter-item-count">${filterStats.laptops}</span>
                    </div>
                    <div class="filter-item">
                        <span class="filter-item-label">Desktops filtered:</span>
                        <span class="filter-item-count">${filterStats.desktops}</span>
                    </div>
                    <div class="filter-item">
                        <span class="filter-item-label">Unknown/Other:</span>
                        <span class="filter-item-count">${filterStats.unknown}</span>
                    </div>
                </div>
            `;
        }

        // ===== EDITABLE CELLS =====
        function handleCellEdit(event) {
            const cell = event.target;
            const rowIdx = parseInt(cell.dataset.rowIndex);
            const header = cell.dataset.header;
            const newValue = cell.textContent.trim();
            const oldValue = originalMappedData[rowIdx][header];

            if (newValue !== String(oldValue)) {
                mappedData[rowIdx][header] = newValue;
                cell.classList.add('edited');
                hasEdits = true;
                editModeIndicator.classList.add('show');
                resetEditsBtn.classList.add('show');
            } else if (newValue === String(originalMappedData[rowIdx][header])) {
                cell.classList.remove('edited');
                // Check if any edits remain
                checkForRemainingEdits();
            }
        }

        function checkForRemainingEdits() {
            hasEdits = mappedData.some((row, idx) =>
                Object.keys(row).some(key => String(row[key]) !== String(originalMappedData[idx][key]))
            );
            editModeIndicator.classList.toggle('show', hasEdits);
            resetEditsBtn.classList.toggle('show', hasEdits);
        }

        function resetEdits() {
            mappedData = JSON.parse(JSON.stringify(originalMappedData));
            hasEdits = false;
            editModeIndicator.classList.remove('show');
            resetEditsBtn.classList.remove('show');
            renderPreviewTable();
            showToast('All edits have been reset');
        }

        // ===== CONSUMABLES DOWNLOAD =====
        function downloadConsumablesCSV() {
            const rows = [['Category', 'Item', 'Count']];

            const categories = {
                'Laptop Accessories': ['Charger (Standard)', 'Charger (High Spec)', 'Laptop Bag', 'Headset', 'Mouse'],
                'iPhone Accessories': ['USB-C Plug', 'Lightning Cable', 'USB-C Cable', 'Lightning EarPods', 'USB-C EarPods', 'iPhone SE Case', 'iPhone SE Rugged Case', 'iPhone SE Screen Protector', 'iPhone 12 Case', 'iPhone 12 Rugged Case', 'iPhone 12 Screen Protector', 'iPhone 14 Case', 'iPhone 14 Rugged Case', 'iPhone 14 Screen Protector', 'iPhone 15 Case', 'iPhone 15 Rugged Case', 'iPhone 15 Screen Protector', 'iPhone 16 Case', 'iPhone 16 Rugged Case', 'iPhone 16 Screen Protector'],
                'iPad Accessories': ['iPad 9th Gen Case', 'iPad 9th Gen Rugged Case', 'iPad 9th Gen Screen Protector', 'iPad 10th Gen Case', 'iPad 10th Gen Rugged Case', 'iPad 10th Gen Screen Protector', 'iPad 11th Gen Case', 'iPad 11th Gen Rugged Case', 'iPad 11th Gen Screen Protector']
            };

            for (const [category, items] of Object.entries(categories)) {
                items.forEach(item => {
                    const count = consumableCounts[item] || 0;
                    if (count > 0) {
                        rows.push([category, item, count]);
                    }
                });
            }

            const csvContent = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const today = new Date();
            const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            link.setAttribute('href', url);
            link.setAttribute('download', `Consumables_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('Consumables CSV downloaded');
        }

        // ===== RENDER PREVIEW TABLE =====
        function renderPreviewTable() {
            const filteredData = filterBySearch(mappedData);
            const totalCount = mappedData.length;
            const filteredCount = filteredData.length;

            // Update count display
            if (searchTerm) {
                outputCount.textContent = `${filteredCount} of ${totalCount} records`;
            } else {
                outputCount.textContent = `${totalCount} records`;
            }

            if (isExpanded) {
                renderExpandedTable(filteredData);
            } else {
                renderCollapsedTable(filteredData);
            }

            // Update source preview if visible
            if (isSourceVisible) {
                renderSourcePreview();
            }
        }

        function renderCollapsedTable(data) {
            const previewRows = data.slice(0, 10);
            previewBody.innerHTML = previewRows.map(row => `
                <tr>
                    <td><span class="badge ${row.STATUS === 'New connection' ? 'badge-new' : 'badge-replacement'}">${row.STATUS}</span></td>
                    <td>${row['Tialis TASK NUMBER'] || '-'}</td>
                    <td>${row['Full Name'] || '-'}</td>
                    <td>${row['Device Type'] || '-'}</td>
                    <td>${row['Device Bundle / Device Type'] || '-'}</td>
                    <td>${row['ASSET Tag'] || '-'}</td>
                </tr>
            `).join('');
        }

        function renderExpandedTable(data) {
            previewBody.innerHTML = data.map((row, displayIdx) => {
                // Find actual index in mappedData for editing
                const actualIdx = mappedData.findIndex(m =>
                    m['IMEI Number'] === row['IMEI Number'] &&
                    m['Serial Number'] === row['Serial Number'] &&
                    m['Full Name'] === row['Full Name']
                );

                return `
                    <tr class="revealing" style="animation-delay: ${Math.min(displayIdx * 15, 300)}ms">
                        ${destHeaders.map(header => {
                    const val = row[header] ?? '';
                    const isEdited = actualIdx >= 0 && String(mappedData[actualIdx][header]) !== String(originalMappedData[actualIdx][header]);
                    const editedClass = isEdited ? 'edited' : '';
                    if (header === 'STATUS') {
                        const badgeClass = val === 'New connection' ? 'badge-new' : 'badge-replacement';
                        return `<td contenteditable="true" data-row-index="${actualIdx}" data-header="${header}" class="${editedClass}" onblur="handleCellEdit(event)"><span class="badge ${badgeClass}">${val}</span></td>`;
                    }
                    return `<td contenteditable="true" data-row-index="${actualIdx}" data-header="${header}" class="${editedClass}" onblur="handleCellEdit(event)">${val || '-'}</td>`;
                }).join('')}
                    </tr>
                `;
            }).join('');
        }

        function processFile(file) {
            const ext = getFileExtension(file.name);
            const reader = new FileReader();

            if (ext === 'csv') {
                reader.onload = (e) => {
                    const text = e.target.result;
                    parseCSV(text, file.name, file.size);
                };
                reader.readAsText(file);
            } else if (ext === 'xlsx' || ext === 'xls') {
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    parseExcel(data, file.name, file.size);
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(text, fileName, fileSize) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                showStatus('error', 'File appears to be empty or invalid');
                return;
            }

            const headers = parseCSVLine(lines[0]);
            sourceData = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header.trim()] = values[index] ? values[index].trim() : '';
                });
                sourceData.push(row);
            }

            updateSourceUI(fileName, fileSize);
            mapData();
            calculateConsumables();
            updateOutputUI();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function parseExcel(data, fileName, fileSize) {
            try {
                const workbook = XLSX.read(data, { type: 'array' });

                // Get the first sheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert to array of objects (header row becomes keys)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });

                if (jsonData.length < 1) {
                    showStatus('error', 'Excel file appears to be empty or invalid');
                    return;
                }

                sourceData = jsonData.map(row => {
                    // Normalize: trim all string values
                    const normalizedRow = {};
                    for (const key in row) {
                        const value = row[key];
                        normalizedRow[key.trim()] = typeof value === 'string' ? value.trim() : String(value);
                    }
                    return normalizedRow;
                });

                updateSourceUI(fileName, fileSize, 'xlsx');
                mapData();
                calculateConsumables();
                updateOutputUI();
            } catch (error) {
                showStatus('error', 'Failed to parse Excel file: ' + error.message);
            }
        }

        // Get value with case-insensitive key lookup
        function getVal(row, ...keys) {
            for (const key of keys) {
                if (row[key] !== undefined && row[key] !== '') return row[key];
                // Try uppercase
                const upper = key.toUpperCase();
                if (row[upper] !== undefined && row[upper] !== '') return row[upper];
                // Try title case
                const title = key.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                if (row[title] !== undefined && row[title] !== '') return row[title];
            }
            return '';
        }

        function getDeviceType(modelRequired, deviceTypeCol) {
            // First check MODEL REQUIRED
            if (modelRequired) {
                const model = modelRequired.toString().toLowerCase();
                if (model.includes('iphone')) return 'iPhone';
                if (model.includes('ipad')) return 'iPad';
            }

            // If MODEL REQUIRED is empty, check DEVICE TYPE column
            if (deviceTypeCol) {
                const deviceType = deviceTypeCol.toString().toLowerCase();
                if (deviceType.includes('iphone')) return 'iPhone';
                if (deviceType.includes('ipad')) return 'iPad';
            }

            return '';
        }

        function getBundleType(modelRequired) {
            if (!modelRequired) return 'Single';
            const model = modelRequired.toString().toLowerCase();
            if (model.includes('bundle')) return 'Bundle';
            return 'Single';
        }

        // Extract IMEI number - handles both "IMEI: 123456789" and plain "123456789" formats
        function extractIMEI(imeiValue) {
            if (!imeiValue) return '';

            const str = imeiValue.toString().trim();

            // Check for various IMEI prefix patterns and remove them
            // Handles: "IMEI: ", "IMEI:", "imei: ", "imei:", "IMEI ", "imei ", etc.
            const prefixPattern = /^imei\s*:\s*/i;
            let cleaned = str.replace(prefixPattern, '').trim();

            // Also handle case where it might just say "IMEI" followed by the number
            const altPattern = /^imei\s+/i;
            cleaned = cleaned.replace(altPattern, '').trim();

            // Extract just the numeric portion (IMEI numbers are 15 digits)
            // This also handles cases like "IMEI: 123456789012345 (some note)"
            const numericMatch = cleaned.match(/\d{14,15}/);
            if (numericMatch) {
                return numericMatch[0];
            }

            // If no 14-15 digit number found, return the cleaned string
            // (in case format is different but still valid)
            return cleaned;
        }

        function getStatus(taskRef, incRef) {
            const task = taskRef?.toString().toUpperCase() || '';
            if (task.includes('SCTASK')) return 'New connection';
            if (!task && incRef) return 'Replacement';
            return 'Replacement';
        }

        function mapData() {
            // Reset filter stats
            filterStats = { total: sourceData.length, iPhones: 0, iPads: 0, laptops: 0, desktops: 0, unknown: 0 };
            sourceRowMapping = [];

            // First pass: collect filter stats
            sourceData.forEach((row, idx) => {
                const modelRequired = getVal(row, 'MODEL REQUIRED', 'Model Required');
                const deviceTypeCol = getVal(row, 'DEVICE TYPE', 'Device Type');
                const deviceType = getDeviceType(modelRequired, deviceTypeCol);
                const modelLower = (modelRequired || '').toLowerCase();
                const dtLower = (deviceTypeCol || '').toLowerCase();

                if (deviceType === 'iPhone') {
                    // Will be processed
                } else if (deviceType === 'iPad') {
                    // Will be processed
                } else if (dtLower.includes('laptop') || modelLower.includes('dell') || modelLower.includes('latitude') || modelLower.includes('laptop')) {
                    filterStats.laptops++;
                } else if (modelLower.includes('desktop') || modelLower.includes('shared desktop')) {
                    filterStats.desktops++;
                } else {
                    filterStats.unknown++;
                }
            });

            // Second pass: create mapped data
            mappedData = [];
            sourceData.forEach((row, sourceIdx) => {
                const deviceType = getDeviceType(
                    getVal(row, 'MODEL REQUIRED', 'Model Required'),
                    getVal(row, 'DEVICE TYPE', 'Device Type')
                );

                if (deviceType !== 'iPhone' && deviceType !== 'iPad') {
                    return;
                }

                // Track which source indices map to output
                sourceRowMapping.push(sourceIdx);

                // Track device type stats
                if (deviceType === 'iPhone') filterStats.iPhones++;
                else if (deviceType === 'iPad') filterStats.iPads++;

                const taskRef = getVal(row, 'TASK REF', 'Task Ref');
                const incRef = getVal(row, 'INC REF', 'Inc Ref');
                const modelRequired = getVal(row, 'MODEL REQUIRED', 'Model Required');
                const deviceTypeCol = getVal(row, 'DEVICE TYPE', 'Device Type');
                let dateToBeShipped = getVal(row, 'DATE TO BE SHIPPED', 'Date To Be Shipped', 'Date to be shipped');

                // Apply Excel date parsing
                dateToBeShipped = parseExcelDate(dateToBeShipped);

                // Use TASK REF if it exists and contains SCTASK, otherwise use INC REF
                let tialisTaskNumber = '';
                if (taskRef && taskRef.toString().toUpperCase().includes('SCTASK')) {
                    tialisTaskNumber = taskRef;
                } else {
                    tialisTaskNumber = incRef;
                }

                mappedData.push({
                    'STATUS': getStatus(taskRef, incRef),
                    'Tialis TASK NUMBER': tialisTaskNumber,
                    'PO (Order date)': dateToBeShipped,
                    'COST CENTRE': '',
                    'Full Name': getVal(row, "USER'S NAME", "User's Name", "USERS NAME"),
                    'Employee ID': '',
                    'Employee Email': '',
                    'Agency': 'DEFRA AGENCY',
                    'Equipment Account': '',
                    'Airtime Account': '',
                    'Device Type': getDeviceType(modelRequired, deviceTypeCol),
                    'Product code': '',
                    'Quanity': 1,
                    'Device Operating System': 'iOS',
                    'Device Make': 'Apple',
                    'EID Number': getVal(row, 'EID NUMBER', 'EID Number', 'Eid Number'),
                    'Serial Number': getVal(row, 'SERIAL NUMBER', 'Serial Number'),
                    'IMEI Number': extractIMEI(getVal(row, 'IMEI NUMBER', 'IMEI Number', 'Imei Number')),
                    'Organisational Group': '',
                    'Talk plan & Bundle': '',
                    'Data cap': '',
                    'Physical SIM Card Required': '',
                    'Physical SIM Card Number': '',
                    'Date Shipped': dateToBeShipped,
                    'ASSET Tag': getVal(row, 'ASSET TAG', 'Asset Tag'),
                    'Device Bundle / Device Type': getBundleType(modelRequired),
                    'iPhone number (to be added by EE)': ''
                });
            });

            // Store original for reset functionality
            originalMappedData = JSON.parse(JSON.stringify(mappedData));

            // Detect duplicates
            detectDuplicates();
        }

        // ===== CONSUMABLES CALCULATION =====

        function isLaptopDevice(deviceType, modelRequired) {
            const dt = (deviceType || '').toLowerCase();
            const model = (modelRequired || '').toLowerCase();

            // Check DEVICE TYPE column first
            if (dt.includes('laptop')) return true;

            // Check MODEL REQUIRED for laptop indicators
            if (model.includes('dell') ||
                model.includes('latitude') ||
                model.includes('laptop') ||
                model.includes('touchscreen')) {
                // Exclude if it says "upgrade from" (might be a trade-in reference)
                // but still count it as a laptop
                return true;
            }

            return false;
        }

        function isMobileDevice(deviceType, modelRequired) {
            const dt = (deviceType || '').toLowerCase();
            const model = (modelRequired || '').toLowerCase();

            // EXCLUDE iPads - they don't use iPhone consumables
            if (model.includes('ipad')) return false;

            // Check DEVICE TYPE column first
            if (dt.includes('mobile') || dt.includes('phone') || dt.includes('iphone')) return true;

            // Check MODEL REQUIRED for iPhone indicators
            if (model.includes('iphone') ||
                model.includes('apple iphone') ||
                model.includes('4.7"') ||
                model.includes('6.1"')) {
                return true;
            }

            return false;
        }

        function isHighSpecLaptop(modelRequired) {
            if (!modelRequired) return false;
            const model = modelRequired.toString().toLowerCase();

            // Explicit high spec indicators
            if (model.includes('high performance') ||
                model.includes('high-performance') ||
                model.includes('high spec') ||
                model.includes('high-spec') ||
                model.includes('i7') ||
                model.includes('enhanced')) {
                return true;
            }

            return false;
        }

        function getPhoneModel(modelRequired, shippingModel) {
            // Priority: check shipping model first (actual shipped device)
            // Use regex with stricter patterns to avoid false matches (e.g., "12" in "12345")
            const shipping = (shippingModel || '').toString().toLowerCase();
            const model = (modelRequired || '').toString().toLowerCase();

            // Check shipping model first (newest models first)
            if (/iphone\s*16/i.test(shipping)) return 'iPhone 16';
            if (/iphone\s*15/i.test(shipping)) return 'iPhone 15';
            if (/iphone\s*14/i.test(shipping)) return 'iPhone 14';
            if (/iphone\s*12/i.test(shipping)) return 'iPhone 12';
            if (/iphone\s*se/i.test(shipping)) return 'iPhone SE';

            // Fall back to MODEL REQUIRED (newest models first)
            if (/iphone\s*16/i.test(model)) return 'iPhone 16';
            if (/iphone\s*15/i.test(model)) return 'iPhone 15';
            if (/iphone\s*14/i.test(model)) return 'iPhone 14';
            if (/iphone\s*12/i.test(model)) return 'iPhone 12';

            // iPhone SE variants (4.7" screens)
            if (/iphone\s*se/i.test(model) ||
                model.includes('se2') || model.includes('se 2nd') || model.includes('se 3rd') ||
                model.includes('se (2nd') || model.includes('se (3rd') || model.includes('4.7')) {
                return 'iPhone SE';
            }

            // 6.1" phones (iPhone 11, XR - use iPhone 14 case as they're similar size)
            if (model.includes('6.1') || /iphone\s*11/i.test(model) || /iphone\s*xr/i.test(model)) {
                return 'iPhone 14';
            }

            // Default to iPhone 14 for standard/unspecified
            return 'iPhone 14';
        }

        function isBundle(modelRequired) {
            if (!modelRequired) return false;
            const model = modelRequired.toString().toLowerCase();
            // Check for bundle indicators
            return model.includes('bundle') ||
                model.includes('standard bundle') ||
                model.includes('rugged bundle');
        }

        function isIPadDevice(deviceType, modelRequired) {
            const dt = (deviceType || '').toLowerCase();
            const model = (modelRequired || '').toLowerCase();

            // Check MODEL REQUIRED for iPad indicators
            if (model.includes('ipad')) return true;

            // Check DEVICE TYPE column
            if (dt.includes('ipad')) return true;

            return false;
        }

        function getIPadModel(modelRequired, shippedModel) {
            // Priority: check shipped model first (actual shipped device)
            const shipped = (shippedModel || '').toString().toLowerCase();
            const model = (modelRequired || '').toString().toLowerCase();

            // Check shipped model for explicit generation
            if (shipped.includes('11th') || shipped.includes('11 gen') || shipped.includes('a14') || shipped.includes('2024')) {
                return 'iPad 11th Gen';
            }
            if (shipped.includes('9th') || shipped.includes('9 gen') || shipped.includes('a13') || shipped.includes('2021')) {
                return 'iPad 9th Gen';
            }
            if (shipped.includes('10th') || shipped.includes('10 gen') || shipped.includes('2022')) {
                return 'iPad 10th Gen';
            }

            // Check MODEL REQUIRED for generation hints
            if (model.includes('11th') || model.includes('11 gen')) {
                return 'iPad 11th Gen';
            }
            if (model.includes('9th') || model.includes('9 gen')) {
                return 'iPad 9th Gen';
            }
            if (model.includes('10th') || model.includes('10 gen')) {
                return 'iPad 10th Gen';
            }

            // Default to 11th Gen for unspecified (most current model)
            return 'iPad 11th Gen';
        }

        function isIPadBundle(modelRequired) {
            if (!modelRequired) return false;
            const model = modelRequired.toString().toLowerCase();
            return model.includes('bundle');
        }

        function isRuggedBundle(modelRequired) {
            if (!modelRequired) return false;
            const model = modelRequired.toString().toLowerCase();
            return model.includes('rugged');
        }

        function calculateConsumables() {
            // Reset counts - now includes USB-C variants
            consumableCounts = {
                // Laptop consumables
                'Charger (Standard)': 0,
                'Charger (High Spec)': 0,
                'Laptop Bag': 0,
                'Headset': 0,
                'Mouse': 0,
                // Mobile cables (Lightning vs USB-C)
                'USB-C Plug': 0,
                'Lightning Cable': 0,
                'USB-C Cable': 0,
                // iPhone accessories
                'Lightning EarPods': 0,
                'USB-C EarPods': 0,
                'iPhone SE Case': 0,
                'iPhone SE Rugged Case': 0,
                'iPhone SE Screen Protector': 0,
                'iPhone 12 Case': 0,
                'iPhone 12 Rugged Case': 0,
                'iPhone 12 Screen Protector': 0,
                'iPhone 14 Case': 0,
                'iPhone 14 Rugged Case': 0,
                'iPhone 14 Screen Protector': 0,
                'iPhone 15 Case': 0,
                'iPhone 15 Rugged Case': 0,
                'iPhone 15 Screen Protector': 0,
                'iPhone 16 Case': 0,
                'iPhone 16 Rugged Case': 0,
                'iPhone 16 Screen Protector': 0,
                // iPad specific
                'iPad 9th Gen Case': 0,
                'iPad 9th Gen Rugged Case': 0,
                'iPad 9th Gen Screen Protector': 0,
                'iPad 10th Gen Case': 0,
                'iPad 10th Gen Rugged Case': 0,
                'iPad 10th Gen Screen Protector': 0,
                'iPad 11th Gen Case': 0,
                'iPad 11th Gen Rugged Case': 0,
                'iPad 11th Gen Screen Protector': 0
            };

            sourceData.forEach(row => {
                const deviceType = getVal(row, 'DEVICE TYPE', 'Device Type', 'Device type');
                const nsRep = getVal(row, 'NS/REP', 'NS/Rep', 'Ns/Rep', 'NS REP', 'NSREP').toUpperCase().trim();
                const modelRequired = getVal(row, 'MODEL REQUIRED', 'Model Required', 'Model required');
                const shippingModel = getVal(row, 'SHIPPING MODEL', 'Shipping Model', 'Shipping model');

                // Determine NS vs REP - anything not explicitly REP is treated as NS
                const isREP = nsRep.includes('REP') || nsRep === 'REPLACEMENT';
                const isNS = !isREP;

                // Skip desktops
                const modelLower = (modelRequired || '').toLowerCase();
                if (modelLower.includes('shared desktop') || modelLower.includes('desktop')) {
                    return;
                }

                // Check if device uses USB-C
                const usesUSBC = isUSBCDevice(modelRequired, shippingModel);

                // ===== LAPTOP RULES =====
                if (isLaptopDevice(deviceType, modelRequired)) {
                    const isHighSpec = isHighSpecLaptop(modelRequired);

                    if (isNS) {
                        if (isHighSpec) {
                            consumableCounts['Charger (High Spec)']++;
                        } else {
                            consumableCounts['Charger (Standard)']++;
                        }
                        consumableCounts['Laptop Bag']++;
                        consumableCounts['Headset']++;
                        consumableCounts['Mouse']++;
                    } else if (isREP) {
                        if (isHighSpec) {
                            consumableCounts['Charger (High Spec)']++;
                        } else {
                            consumableCounts['Charger (Standard)']++;
                        }
                    }
                }

                // ===== MOBILE/iPhone RULES =====
                if (isMobileDevice(deviceType, modelRequired)) {
                    const phoneModel = getPhoneModel(modelRequired, shippingModel);
                    const isBundleRequest = isBundle(modelRequired);

                    // All mobile devices get USB-C plug + cable (Lightning or USB-C)
                    consumableCounts['USB-C Plug']++;
                    if (usesUSBC) {
                        consumableCounts['USB-C Cable']++;
                    } else {
                        consumableCounts['Lightning Cable']++;
                    }

                    // Bundle orders get EarPods + case + SP
                    if (isBundleRequest) {
                        if (usesUSBC) {
                            consumableCounts['USB-C EarPods']++;
                        } else {
                            consumableCounts['Lightning EarPods']++;
                        }

                        const isRugged = modelRequired.toLowerCase().includes('rugged');

                        // Use phoneModel directly (now includes iPhone 15/16)
                        if (phoneModel === 'iPhone 16') {
                            if (isRugged) {
                                consumableCounts['iPhone 16 Rugged Case']++;
                            } else {
                                consumableCounts['iPhone 16 Case']++;
                            }
                            consumableCounts['iPhone 16 Screen Protector']++;
                        } else if (phoneModel === 'iPhone 15') {
                            if (isRugged) {
                                consumableCounts['iPhone 15 Rugged Case']++;
                            } else {
                                consumableCounts['iPhone 15 Case']++;
                            }
                            consumableCounts['iPhone 15 Screen Protector']++;
                        } else if (phoneModel === 'iPhone SE') {
                            if (isRugged) {
                                consumableCounts['iPhone SE Rugged Case']++;
                            } else {
                                consumableCounts['iPhone SE Case']++;
                            }
                            consumableCounts['iPhone SE Screen Protector']++;
                        } else if (phoneModel === 'iPhone 12') {
                            if (isRugged) {
                                consumableCounts['iPhone 12 Rugged Case']++;
                            } else {
                                consumableCounts['iPhone 12 Case']++;
                            }
                            consumableCounts['iPhone 12 Screen Protector']++;
                        } else {
                            // Default: iPhone 14 (includes 11, XR, etc.)
                            if (isRugged) {
                                consumableCounts['iPhone 14 Rugged Case']++;
                            } else {
                                consumableCounts['iPhone 14 Case']++;
                            }
                            consumableCounts['iPhone 14 Screen Protector']++;
                        }
                    }
                }

                // ===== iPad RULES =====
                if (isIPadDevice(deviceType, modelRequired)) {
                    const isBundleRequest = isIPadBundle(modelRequired);

                    // ALL iPads get USB-C plug + cable (not just bundles)
                    consumableCounts['USB-C Plug']++;
                    if (usesUSBC) {
                        consumableCounts['USB-C Cable']++;
                    } else {
                        consumableCounts['Lightning Cable']++;
                    }

                    // Bundle orders additionally get case + screen protector
                    if (isBundleRequest) {
                        const shippedModel = getVal(row, 'SHIPPED MODEL', 'Shipped Model', 'shipped model', 'SHIPPING MODEL', 'Shipping Model');
                        const iPadModel = getIPadModel(modelRequired, shippedModel);
                        const isRugged = isRuggedBundle(modelRequired);

                        // Case & Screen Protector based on iPad model
                        if (iPadModel === 'iPad 9th Gen') {
                            if (isRugged) {
                                consumableCounts['iPad 9th Gen Rugged Case']++;
                            } else {
                                consumableCounts['iPad 9th Gen Case']++;
                            }
                            consumableCounts['iPad 9th Gen Screen Protector']++;
                        } else if (iPadModel === 'iPad 10th Gen') {
                            if (isRugged) {
                                consumableCounts['iPad 10th Gen Rugged Case']++;
                            } else {
                                consumableCounts['iPad 10th Gen Case']++;
                            }
                            consumableCounts['iPad 10th Gen Screen Protector']++;
                        } else {
                            // Default to 11th Gen
                            if (isRugged) {
                                consumableCounts['iPad 11th Gen Rugged Case']++;
                            } else {
                                consumableCounts['iPad 11th Gen Case']++;
                            }
                            consumableCounts['iPad 11th Gen Screen Protector']++;
                        }
                    }
                }
            });

            updateConsumablesUI();
        }

        function updateConsumablesUI() {
            // Filter to only show items with count > 0 or all items grouped
            const laptopItems = [
                { name: 'Charger (Standard)', count: consumableCounts['Charger (Standard)'] || 0 },
                { name: 'Charger (High Spec)', count: consumableCounts['Charger (High Spec)'] || 0 },
                { name: 'Laptop Bag', count: consumableCounts['Laptop Bag'] || 0 },
                { name: 'Headset', count: consumableCounts['Headset'] || 0 },
                { name: 'Mouse', count: consumableCounts['Mouse'] || 0 }
            ];

            // iPhone accessories - includes cables/plugs and phone-specific items
            const iPhoneItems = [
                { name: 'USB-C Plug', count: consumableCounts['USB-C Plug'] || 0 },
                { name: 'Lightning Cable', count: consumableCounts['Lightning Cable'] || 0 },
                { name: 'USB-C Cable', count: consumableCounts['USB-C Cable'] || 0 },
                { name: 'Lightning EarPods', count: consumableCounts['Lightning EarPods'] || 0 },
                { name: 'USB-C EarPods', count: consumableCounts['USB-C EarPods'] || 0 },
                { name: 'iPhone SE Case', count: consumableCounts['iPhone SE Case'] || 0 },
                { name: 'iPhone SE Rugged Case', count: consumableCounts['iPhone SE Rugged Case'] || 0 },
                { name: 'iPhone SE Screen Protector', count: consumableCounts['iPhone SE Screen Protector'] || 0 },
                { name: 'iPhone 12 Case', count: consumableCounts['iPhone 12 Case'] || 0 },
                { name: 'iPhone 12 Rugged Case', count: consumableCounts['iPhone 12 Rugged Case'] || 0 },
                { name: 'iPhone 12 Screen Protector', count: consumableCounts['iPhone 12 Screen Protector'] || 0 },
                { name: 'iPhone 14 Case', count: consumableCounts['iPhone 14 Case'] || 0 },
                { name: 'iPhone 14 Rugged Case', count: consumableCounts['iPhone 14 Rugged Case'] || 0 },
                { name: 'iPhone 14 Screen Protector', count: consumableCounts['iPhone 14 Screen Protector'] || 0 },
                { name: 'iPhone 15 Case', count: consumableCounts['iPhone 15 Case'] || 0 },
                { name: 'iPhone 15 Rugged Case', count: consumableCounts['iPhone 15 Rugged Case'] || 0 },
                { name: 'iPhone 15 Screen Protector', count: consumableCounts['iPhone 15 Screen Protector'] || 0 },
                { name: 'iPhone 16 Case', count: consumableCounts['iPhone 16 Case'] || 0 },
                { name: 'iPhone 16 Rugged Case', count: consumableCounts['iPhone 16 Rugged Case'] || 0 },
                { name: 'iPhone 16 Screen Protector', count: consumableCounts['iPhone 16 Screen Protector'] || 0 }
            ];

            // iPad specific items - now includes iPad 10th Gen
            const iPadItems = [
                { name: 'iPad 9th Gen Case', count: consumableCounts['iPad 9th Gen Case'] || 0 },
                { name: 'iPad 9th Gen Rugged Case', count: consumableCounts['iPad 9th Gen Rugged Case'] || 0 },
                { name: 'iPad 9th Gen Screen Protector', count: consumableCounts['iPad 9th Gen Screen Protector'] || 0 },
                { name: 'iPad 10th Gen Case', count: consumableCounts['iPad 10th Gen Case'] || 0 },
                { name: 'iPad 10th Gen Rugged Case', count: consumableCounts['iPad 10th Gen Rugged Case'] || 0 },
                { name: 'iPad 10th Gen Screen Protector', count: consumableCounts['iPad 10th Gen Screen Protector'] || 0 },
                { name: 'iPad 11th Gen Case', count: consumableCounts['iPad 11th Gen Case'] || 0 },
                { name: 'iPad 11th Gen Rugged Case', count: consumableCounts['iPad 11th Gen Rugged Case'] || 0 },
                { name: 'iPad 11th Gen Screen Protector', count: consumableCounts['iPad 11th Gen Screen Protector'] || 0 }
            ];

            // Calculate totals
            const totalItems = Object.values(consumableCounts).reduce((a, b) => a + b, 0);
            const hasLaptopItems = laptopItems.some(item => item.count > 0);
            const hasIPhoneItems = iPhoneItems.some(item => item.count > 0);
            const hasIPadItems = iPadItems.some(item => item.count > 0);

            if (totalItems === 0) {
                consumablesEmpty.style.display = 'block';
                consumablesContent.style.display = 'none';
                consumablesBadge.textContent = '0 ITEMS';
                return;
            }

            consumablesEmpty.style.display = 'none';
            consumablesContent.style.display = 'block';
            consumablesBadge.textContent = `${totalItems} ITEMS`;
            consumablesTotalCount.textContent = totalItems;

            let html = '';

            // Laptop section
            if (hasLaptopItems) {
                html += `<tr><td colspan="2" class="consumable-category">Laptop Accessories</td></tr>`;
                laptopItems.forEach(item => {
                    if (item.count > 0) {
                        html += `
                            <tr>
                                <td>
                                    <div class="consumable-item-name">
                                        <div class="consumable-dot laptop"></div>
                                        ${item.name}
                                    </div>
                                </td>
                                <td class="has-count">${item.count}</td>
                            </tr>
                        `;
                    }
                });
            }

            // iPhone Accessories section (includes cables, plugs, cases, screen protectors)
            if (hasIPhoneItems) {
                html += `<tr><td colspan="2" class="consumable-category">iPhone Accessories</td></tr>`;
                iPhoneItems.forEach(item => {
                    if (item.count > 0) {
                        html += `
                            <tr>
                                <td>
                                    <div class="consumable-item-name">
                                        <div class="consumable-dot mobile"></div>
                                        ${item.name}
                                    </div>
                                </td>
                                <td class="has-count">${item.count}</td>
                            </tr>
                        `;
                    }
                });
            }

            // iPad specific section
            if (hasIPadItems) {
                html += `<tr><td colspan="2" class="consumable-category">iPad Accessories</td></tr>`;
                iPadItems.forEach(item => {
                    if (item.count > 0) {
                        html += `
                            <tr>
                                <td>
                                    <div class="consumable-item-name">
                                        <div class="consumable-dot tablet"></div>
                                        ${item.name}
                                    </div>
                                </td>
                                <td class="has-count">${item.count}</td>
                            </tr>
                        `;
                    }
                });
            }

            consumablesBody.innerHTML = html;
        }

        function clearConsumables() {
            consumableCounts = {};
            consumablesEmpty.style.display = 'block';
            consumablesContent.style.display = 'none';
            consumablesBadge.textContent = '0 ITEMS';
            consumablesBody.innerHTML = '';
        }

        function updateSourceUI(fileName, fileSize, fileType = 'csv') {
            const sizeStr = fileSize > 1024 ? `${(fileSize / 1024).toFixed(1)} KB` : `${fileSize} B`;
            const typeLabel = fileType.toUpperCase();

            sourceContent.innerHTML = `
                <div class="file-loaded animate-in">
                    <div class="file-icon">${typeLabel}</div>
                    <div class="file-details">
                        <div class="file-name">${fileName}</div>
                        <div class="file-meta">${sizeStr} &bull; ${sourceData.length} rows loaded</div>
                    </div>
                    <button class="btn-clear" onclick="clearFile()">Clear</button>
                </div>
            `;
        }

        function updateOutputUI() {
            if (mappedData.length === 0) {
                showStatus('error', 'No iPhone or iPad records found in the source file');
                return;
            }

            // Reset expanded state when new data loads
            isExpanded = false;
            expandBtn.classList.remove('expanded');
            expandBtnText.textContent = 'Expand All Rows & Columns';
            previewScroll.classList.remove('expanded');
            previewTable.classList.remove('expanded');
            columnIndicator.style.display = 'none';

            // Reset header to preview columns
            previewHead.innerHTML = `
                <tr>
                    <th>Status</th>
                    <th>Task Number</th>
                    <th>Full Name</th>
                    <th>Device</th>
                    <th>Bundle</th>
                    <th>Asset Tag</th>
                </tr>
            `;

            // Build status message with optional warnings
            let statusHtml = `Successfully mapped ${mappedData.length} iPhone/iPad records`;

            // Add filter breakdown if rows were filtered
            const filtered = filterStats.total - filterStats.iPhones - filterStats.iPads;
            if (filtered > 0) {
                statusHtml += ` (${filtered} non-iPhone/iPad rows filtered)`;
            }

            showStatus('success', statusHtml);

            // Display duplicate warnings if any
            const duplicateHtml = renderDuplicateWarnings();
            if (duplicateHtml) {
                statusArea.innerHTML += duplicateHtml;
            }

            // Display filter breakdown
            const filterHtml = renderFilterBreakdown();
            if (filterHtml) {
                statusArea.innerHTML += filterHtml;
            }

            outputCount.textContent = `${mappedData.length} records`;

            // Show preview section, hide empty state
            previewSection.style.display = 'block';
            emptyPreview.style.display = 'none';

            // Generate preview rows using the new render function
            renderPreviewTable();

            // Always show expand button if there's data
            if (mappedData.length > 0) {
                expandBtn.style.display = 'flex';
                previewFade.classList.remove('hidden');
            } else {
                expandBtn.style.display = 'none';
            }
        }

        function toggleExpand() {
            isExpanded = !isExpanded;

            if (isExpanded) {
                // Expand: show all rows and all columns
                expandBtn.classList.add('expanded');
                expandBtnText.textContent = 'Collapse';
                previewScroll.classList.add('expanded');
                previewTable.classList.add('expanded');
                previewFade.classList.add('hidden');
                columnIndicator.style.display = 'inline-flex';
                columnCount.textContent = `${destHeaders.length} cols`;

                // Update header to show all columns
                previewHead.innerHTML = `
                    <tr>
                        ${destHeaders.map(h => `<th>${h}</th>`).join('')}
                    </tr>
                `;

                // Use renderPreviewTable which handles editable cells and search filtering
                renderPreviewTable();

            } else {
                // Collapse: show preview (10 rows, 6 columns)
                expandBtn.classList.remove('expanded');
                expandBtnText.textContent = 'Expand All Rows & Columns';
                previewScroll.classList.remove('expanded');
                previewTable.classList.remove('expanded');
                previewFade.classList.remove('hidden');
                columnIndicator.style.display = 'none';

                // Reset header to preview columns
                previewHead.innerHTML = `
                    <tr>
                        <th>Status</th>
                        <th>Task Number</th>
                        <th>Full Name</th>
                        <th>Device</th>
                        <th>Bundle</th>
                        <th>Asset Tag</th>
                    </tr>
                `;

                // Use renderPreviewTable which handles search filtering
                renderPreviewTable();

                // Scroll back to top
                previewScroll.scrollTop = 0;
            }
        }

        function showStatus(type, message) {
            const icon = type === 'success'
                ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
                : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';

            statusArea.innerHTML = `
                <div class="status-message ${type} animate-in">
                    ${icon}
                    <span>${message}</span>
                </div>
            `;
        }

        function downloadCSV() {
            const csvContent = [
                destHeaders.join(','),
                ...mappedData.map(row =>
                    destHeaders.map(header => {
                        const value = String(row[header] ?? '');
                        return value.includes(',') || value.includes('"') || value.includes('\n')
                            ? `"${value.replace(/"/g, '""')}"`
                            : value;
                    }).join(',')
                )
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            const today = new Date();
            const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            link.setAttribute('href', url);
            link.setAttribute('download', `Mapped_EE_Data_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('CSV file downloaded successfully');
        }

        function clearFile() {
            sourceData = [];
            mappedData = [];
            originalMappedData = [];
            filterStats = { total: 0, iPhones: 0, iPads: 0, laptops: 0, desktops: 0, unknown: 0 };
            duplicateWarnings = { imei: [], serial: [], asset: [] };
            searchTerm = '';
            hasEdits = false;
            sourceRowMapping = [];
            isSourceVisible = false;
            clearConsumables();

            sourceContent.innerHTML = `
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10 9 9 9 8 9"/>
                        </svg>
                    </div>
                    <p>Drop your CSV or Excel file here</p>
                    <span class="hint">Supports .csv, .xlsx, .xls</span>
                </div>
            `;

            // Rebind events
            initDropZone(document.getElementById('dropZone'));

            previewSection.style.display = 'none';
            emptyPreview.style.display = 'block';
            statusArea.innerHTML = '';
            fileInput.value = '';

            // Reset expanded state
            isExpanded = false;
            expandBtn.style.display = 'none';
            expandBtn.classList.remove('expanded');
            expandBtnText.textContent = 'Expand All Rows & Columns';
            previewScroll.classList.remove('expanded');
            previewTable.classList.remove('expanded');
            previewFade.classList.remove('hidden');
            columnIndicator.style.display = 'none';

            // Reset new UI elements
            searchInput.value = '';
            sourceToggleBtn.classList.remove('active');
            sourcePreviewSection.style.display = 'none';
            editModeIndicator.classList.remove('show');
            resetEditsBtn.classList.remove('show');
            sourceHead.innerHTML = '';
            sourceBody.innerHTML = '';
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>

</html>